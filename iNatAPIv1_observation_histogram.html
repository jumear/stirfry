<!DOCTYPE html>
<html lang="en">

<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="description" content="iNaturalist Observation Histogram" />
<title>iNaturalist Observation Histogram</title>
<style>
   body { font:10pt Sans-Serif; }
   .tar { text-align:right; }
   #main { width:100%; }
   table, thead, tbody, tr, td { margin:0px; padding:3px; border-width:1px 0px;border-style:solid; border-color:lightgray; border-spacing:0px; border-collapse:collapse; }
   thead tr { font-weight:600; background:green; color:white; }
   tfoot tr { font-weight:600; background:black; color:white; }
   tr { background:whitesmoke; }
   tr:nth-child(even) {background-color:white }
   .icon { height:48px; width:48px; border-radius:50%; }
   img { margin:0px; padding:0px; border:0px; }
   a { text-decoration:none; }
</style>
<script src="https://d3js.org/d3.v5.min.js"></script>
</head>

<body>
<script>
let winurlstr = window.location.href;
let winurlsearchstr = window.location.search;
let winurlexsearchstr = winurlstr.replace(winurlsearchstr,'');
var winurlparams = new URLSearchParams(winurlsearchstr.substring(1));

var p_date_field = winurlparams.get('date_field');
var l_date_field = ( p_date_field==='created' ) ? 'Created' : 'Observed'; // default is observed

var p_interval = winurlparams.get('interval');
var l_interval = ( p_interval==='year' ) ? 'Year'
   : ( p_interval==='month' ) ? 'Month'
   : ( p_interval==='week' ) ? 'Week'
   : ( p_interval==='day' ) ? 'Day'
   : ( p_interval==='hour' ) ? 'Hour'
   : ( p_interval==='week_of_year' ) ? 'Week of Year'
   : 'Month of Year'; // default is month_of_year

function furl(url,txt=url) { return '<a href="'+url+'">'+txt+'</a>'; };
function famp(str) { return str.replace(/&/g,'&amp;'); };
function fcomnum(n) { return n.toString().replace(/\B(?=(\d{3})+(?!\d))/g,',') };
function fpct(d,p=1) {
   x = d*100;
   return x.toFixed(p);
};
function faddelem(etype,eparent,eclass=null,eid=null,ehtml=null) {
   var eobj = document.createElement(etype);
   if (eclass!==null) { eobj.classList = eclass };
   if (eid!==null) { eobj.id = eid };
   if (ehtml!==null) { eobj.innerHTML = ehtml };
   eparent.appendChild(eobj);
   return eobj;
};
function fresults(xobj) {
   var results = xobj.results;
   var robj = results[Object.keys(results)[0]];
   if (!robj || !robj[Object.keys(robj)[0]]) {
      faddelem('p',document.body,null,null,'No results returned.');
      return false;
   };
   var intdesc = l_date_field+' '+l_interval;
   var t=0;
   var m=0;
   var ms='';
   var data = [];
   for (const property in robj) {
      var c=robj[property];
      t=t+c; // total count
      m=c>m?c:m; // max count
      data.push({interval:property,count:c});
   };
   faddelem('p',document.body,null,null,'total records: '+fcomnum(xobj.total_results)+'<br />'
      +'total observation count: '+fcomnum(t)+'<br />'
      +intdesc.toLowerCase()+' max count: '+fcomnum(m)+'<br />'
      +'max '+ intdesc.toLowerCase()+': <span id="maxint"></span>'
   );
   fvisualize(data); // add chart
   //table headers
   var table = faddelem('table',document.body,null,'main');
   var thead = faddelem('thead',table);
   var hrow = faddelem('tr',thead);
   faddelem('td',hrow,null,null,'#');
   faddelem('td',hrow,null,null,l_date_field+' '+l_interval);
   faddelem('td',hrow,'tar',null,'Count');
   faddelem('td',hrow,'tar',null,'% of Total');
   faddelem('td',hrow,'tar',null,'% of Max');
   //table rows
   var tbody = faddelem('tbody',table);
   for (i=0;i<data.length;i++) {
      var c = data[i].count;
      var int = data[i].interval;
      ms=c<m?ms:(ms===''?int:ms+', '+int); // max day(s)
      var brow = faddelem('tr',tbody);
      faddelem('td',brow,null,null,i+1);
      faddelem('td',brow,null,null,int);
      faddelem('td',brow,'tar',null,fcomnum(c));
      faddelem('td',brow,'tar',null,fpct(c/t,2));
      faddelem('td',brow,'tar',null,fpct(c/m));
   };
   //table footers
   var tfoot = faddelem('tfoot',table);
   var frow = faddelem('tr',tfoot);
   faddelem('td',frow,null,null,'Total');
   faddelem('td',frow,null,null,'');
   faddelem('td',frow,'tar',null,fcomnum(t));
   faddelem('td',frow,'tar',null,fpct(t/t,2));
   faddelem('td',frow,'tar',null,'');
   document.getElementById('maxint').innerHTML=ms;
};

function fvisualize(data) { //adapted from https://observablehq.com/@d3/zoomable-bar-chart
   var rotatex = (!p_interval || p_interval==='month_of_year' || data.length<=8)?false:true;
   var maxcount = d3.max(data, d => d.count);
   var margin = ({top:5, right:0, bottom:(rotatex?70:30), left:(maxcount>=900000?56:maxcount>=900?48:32)});
   var width = window.innerWidth*0.8;
   var height = 200;
   //var height = width/3;
   //height = (height<200)?200:(height>300)?300:height;
   var maxzoom = Math.ceil(data.length/15);
   var x = d3.scaleBand()
      .domain(data.map(d => d.interval))
      .range([margin.left, width - margin.right])
      .padding(0.1);
   var y = d3.scaleLinear()
      .domain([0, maxcount]).nice()
      .range([height - margin.bottom, margin.top]);
   var xAxis = g=> {
      g.attr("transform", `translate(0,${height - margin.bottom})`)
      .call(d3.axisBottom(x).tickSizeOuter(0));
      if (rotatex) {
         g.selectAll("text") 
         .style("text-anchor","end")
         .attr("dx","-.8em")
         .attr("dy",".15em")
         .attr("transform", "rotate(-65)");
      };
   };
   var yAxis = g => g
      .attr("transform", `translate(${margin.left},0)`)
      .call(d3.axisLeft(y));
      //.call(g => g.select(".domain").remove());

   const svg = d3.select("body")
      .append("svg")
      .attr("viewBox", [0, 0, width, height])
      .call(zoom);
   svg.append("g")
      .attr("class","bars")
      .attr("fill","gray")
      .selectAll("rect")
      .data(data)
      .join("rect")
      .attr("x", d => x(d.interval))
      .attr("y", d => y(d.count))
      .attr("height", d => y(0) - y(d.count))
      .attr("width", x.bandwidth());
   svg.append("g")
      .attr("class", "x-axis")
      .call(xAxis);
   svg.append("g")
      .attr("class", "y-axis")
      .call(yAxis);
   return svg.node();

   function zoom(svg) {
      const extent = [[margin.left, margin.top], [width - margin.right, height - margin.top]];
      svg.call(d3.zoom()
         .scaleExtent([1,maxzoom])
         .translateExtent(extent)
         .extent(extent)
         .on("zoom", zoomed));
      function zoomed() {
         x.range([margin.left, width - margin.right].map(d => d3.event.transform.applyX(d)));
         svg.selectAll(".bars rect").attr("x", d => x(d.interval)).attr("width", x.bandwidth());
         svg.selectAll(".x-axis").call(xAxis);
      };
   };
};

var apibase = 'https://api.inaturalist.org/v1/observations/histogram';
var apiurl = apibase+((winurlparams!='')?('?'+winurlparams):'');
var apirefurl = furl('https://api.inaturalist.org/v1/docs/#!/Observations/get_observations_histogram','Observation Histogram');
faddelem('h1',document.body,null,null,'iNaturalist Observation Count by '+l_date_field+' '+l_interval);

if (winurlsearchstr==='') {
   faddelem('p',document.body,null,null,'This page will present results from the iNaturalist '+apirefurl+' API endpoint in a friendly format. It also visualizes the data in a bar chart (using D3.js) that is zoomable along the X axis (in cases where there are more than 15 ticks). This page requires that you append some parameters to your URL.');
   faddelem('p',document.body,null,null,'Suppose the address of this page is '+winurlexsearchstr+', <br />and you want to see the results of '+furl(famp(apibase+'?interval=day&d1=2010-01-01&user_id=bob'))+' in a friendly format, <br />then you would open '+furl(famp(winurlexsearchstr+'?interval=day&d1=2010-01-01&user_id=bob'))+' in your browser.');
   faddelem('p',document.body,null,null,"Note that if you use interval=day and date_field=observed, you can set a beginning date (ex. d1=2010-01-01) to pull back more than just the last year's observed days.<br />Similarly, if you use interval=day and date_field=created, you can set a beginning date (created_d1) to pull back more than just the last year's created days.");
}
else {
   faddelem('p',document.body,null,null,'This is the base query: '+furl(famp(apiurl))+'. (This page will accept most parameters from the iNaturalist '+apirefurl+' API endpoint.)');
   fetch(apiurl)
      .then((response) => {
         if (!response.ok) { throw new Error(response.status+' ('+response.statusText+') returned from '+response.url); };
         return response.json();
      })
      .then((data) => { fresults(data); })
      .catch((err) => {
         console.error(err.message);
         faddelem('p',document.body,null,null,'There was a problem retrieving data. Error '+err.message+'.')
      });
};

</script>
</body>

</html>