<!DOCTYPE html>
<html lang="en">

<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="description" content="iNaturalist Identification Counts by Iconic Taxa" />
<title>iNaturalist Identification Counts by Iconic Taxa</title>
<style>
   body { font:10pt Sans-Serif; }
   .tar { text-align:right; }
   #main { width:100%; }
   table, thead, tbody, tr, td { margin:0px; padding:3px; border-width:1px 0px;border-style:solid; border-color:lightgray; border-spacing:0px; border-collapse:collapse; }
   thead tr { font-weight:600; background:green; color:white; }
   tfoot tr { font-weight:600; background:black; color:white; }
   tr { background:whitesmoke; }
   tr:nth-child(even) {background-color:white }
   .icon { height:48px; width:48px; border-radius:50%; }
   img { margin:0px; padding:0px; border:0px; }
   a { text-decoration:none; }
</style>
</head>

<body>
<script>
let winurlstr = window.location.href;
let winurlsearchstr = window.location.search;
let winurlexsearchstr = winurlstr.replace(winurlsearchstr,'');
var winurlparams = new URLSearchParams(winurlsearchstr.substring(1));
winurlparams.delete('per_page');
winurlparams.delete('only_id');
winurlparams.delete('verifiable');
winurlparams.delete('quality_grade');
winurlparams.delete('iconic_taxa');

function furl(url,txt=url) { return '<a href="'+url+'">'+txt+'</a>'; };
function famp(str) { return str.replace(/&/g,'&amp;'); };
function fcomnum(n) { return n.toString().replace(/\B(?=(\d{3})+(?!\d))/g,',') };
function fpct(d,p=1) {
   x = d*100;
   return x.toFixed(p);
};

function faddelem(etype,eparent,eclass=null,eid=null,ehtml=null) {
   var eobj = document.createElement(etype);
   if (eclass!==null) { eobj.classList = eclass };
   if (eid!==null) { eobj.id = eid };
   if (ehtml!==null) { eobj.innerHTML = ehtml };
   eparent.appendChild(eobj);
   return eobj;
};
function fsettdvalue(rlabel,clabel,val) {
   document.getElementById(rlabel+'_'+clabel).innerHTML = val;
};
function fgetcount(url) {
   return fetch(url)
      .then((response) => {
         if (!response.ok) { throw new Error(response.status+': '+response.statusText); };
         return response.json();
      })
      .then((data) => { return data.total_results; })
      .catch((err) => { console.error(err); });
};

var apiurl = 'https://api.inaturalist.org/v1/identifications?per_page=0&only_id=true'+((winurlparams!='')?('&'+winurlparams):'');
var ary_it = [
   {icon_taxa:"Mammalia",disp_name:"Mammals",id:40151,icon:"🐒",color:"mediumblue"},
   {icon_taxa:"Aves",disp_name:"Birds",id:3,icon:"🦅",color:"blue"},
   {icon_taxa:"Reptilia",disp_name:"Reptiles",id:26036,icon:"🐍",color:"darkblue"},
   {icon_taxa:"Amphibia",disp_name:"Amphibians",id:20978,icon:"🐸",color:"navy"},
   {icon_taxa:"Actinopterygii",disp_name:"Ray-Finned Fish",id:47178,icon:"🐠",color:"midnightblue"},
   {icon_taxa:"Mollusca",disp_name:"Mollusks",id:47115,icon:"🐌",color:"orangered"},
   {icon_taxa:"Insecta",disp_name:"Insects",id:47158,icon:"🐞",color:"red"},
   {icon_taxa:"Arachnida",disp_name:"Arachnids",id:47119,icon:"🕷",color:"crimson"},
   {icon_taxa:"Animalia",disp_name:"Other Animals",id:1,icon:"🦀",color:"royalblue"},
   {icon_taxa:"Plantae",disp_name:"Plants",id:47126,icon:"🌱",color:"green"},
   {icon_taxa:"Fungi",disp_name:"Fungi",id:47170,icon:"🍄",color:"magenta"},
   {icon_taxa:"Chromista",disp_name:"Chromista",id:48222,color:"saddlebrown"},
   {icon_taxa:"Protozoa",disp_name:"Protozoa",id:47686,color:"purple"},
   {icon_taxa:"Other",disp_name:"Other (Unknown)",id:48460,color:"gray"},
   {icon_taxa:"All",disp_name:"All",icon:"🌐",color:"none"},
];
faddelem('h1',document.body,null,null,'iNaturalist Identification Counts by Iconic Taxa');
// create the basic structure of the table
var table = faddelem('table',document.body,null,'main');
var thead = faddelem('thead',table);
var hrow = faddelem('tr',thead);
faddelem('td',hrow,null,null,'Iconic Taxon');
faddelem('td',hrow);
faddelem('td',hrow,'tar',null,'Count');
faddelem('td',hrow,'tar',null,'% of All');
var tbody = faddelem('tbody',table);
var tfoot = faddelem('tfoot',table);
for (i=0;i<ary_it.length;i++) {
   var str_it = ary_it[i].icon_taxa;
   var str_dn = ary_it[i].disp_name;
   var str_ic = ary_it[i].icon;
   var trow = faddelem('tr',(str_it==='All'?tfoot:tbody));
   faddelem('td',trow,null,str_it+'_it',str_dn);
   faddelem('td',trow,null,str_it+'_ic',str_ic);
   faddelem('td',trow,'tar',str_it+'_n');
   faddelem('td',trow,'tar',str_it+'_pct');
};
faddelem('p',document.body,null,null,'Notes:<br />'
   +'1. Because these numbers may be retrieved at slightly different times, this may not represent a true snapshot at a single point in time.<br />'
   +'2. This is the base query: '+furl(famp(apiurl))+'. (This page will accept most parameters from the iNaturalist API '+furl('https://api.inaturalist.org/v1/docs/#!/Identifications/get_identifications','Identification Search')+' endpoint.)<br />'
   +'3. Due to API request limits, you may not want to run this page multiple times in quick succession. If it looks like only some data is pulling back, wait a moment before trying to pull data again.'
);

var data = [];
// pull data into table
// (this is separate from the creation of the table structure just in case there are failures while pulling data)
for (j=0;j<(ary_it.length-1);j++) { // note that this is using length-1 because it will purposely exclude 'other' from the iteration set.
   if ((j+1)===(ary_it.length-1)) { j++; } // jump past 'other' and go to 'all'
   var str_it = ary_it[j].icon_taxa
   var n_it = ary_it[j].id
   var p_it = n_it?('&iconic_taxon_id='+n_it):'';
   var prom0 = Promise.resolve(str_it);
   var prom1 = fgetcount(apiurl+p_it);
   Promise.all([prom0,prom1]).then(function(values) {
      var it = values[0];
      var n  = values[1];
      fsettdvalue(it,'n',fcomnum(n));
      data.push({taxon:it,count:n});

      //if this is the last iteration in the set to finish, then it will also calculate percents
      if (data.length===(ary_it.length-1)) {
         var n_ttl = 0;
         var n_ex_unk = 0;
         for (k=0;k<data.length;k++) {
            if (data[k].taxon==='All') { n_ttl = data[k].count; }
            else { n_ex_unk += data[k].count; }
         };
         for (l=0;l<data.length;l++) { fsettdvalue(data[l].taxon,'pct',fpct(data[l].count/n_ttl)); };
         var oth = 'Other'
         fsettdvalue(oth,'n',fcomnum(n_ttl-n_ex_unk));
         fsettdvalue(oth,'pct',fpct(1-n_ex_unk/n_ttl));
      };
   });  
};
</script>
</body>

</html>