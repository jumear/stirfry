<!DOCTYPE html>
<html lang="en">

<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="description" content="Georgie Sightings" />
<title>Georgie Sightings</title>
<style>
   html { height:100vh; }
   body { height:100vh; width:100vw; margin:0px; }
   #nav { padding:5px; font:600 15pt Sans-serif; width:290px; height:calc(100vh - 10px); color:whitesmoke; background:yellowgreen; }
   #tweet { width:290px; }
   #mapid { display:block; position:absolute; top:0px; left:300px; min-width:250px; width:calc(100vw - 300px); height:100vh; background:darkgray; }
   p { margin:0px }
</style>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css" integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ==" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js" integrity="sha512-GffPMF3RvMeYyc1LWMHtK8EbPv0iNZ8/oTtHPx9/cc2ILxQ+u905qIwdpULaqDkyBKgOaB57QTMg7ztg8Jm2Og==" crossorigin=""></script>
<script async defer src="https://platform.twitter.com/widgets.js"></script>
<!--<script async defer src="http://www.instagram.com/embed.js"></script>//-->
<script>
// debug grid example from https://leafletjs.com/examples/extending/extending-2-layers.html
L.GridLayer.DebugCoords = L.GridLayer.extend({
   createTile: function (coords) {
      var tile = document.createElement('div');
      tile.innerHTML = [coords.x, coords.y, coords.z].join(', ');
      tile.style.outline = '1px solid red';
      return tile;
   }
});
L.gridLayer.debugCoords = function(opts) {
   return new L.GridLayer.DebugCoords(opts);
};

</script>
</head>
<body>
<div id="nav">
<svg height="38" width="290">
  <text x="0" y="30" stroke="white" stroke-width="1.25px" style="font:600 32px sans-serif; fill:red">Georgie Sightings</text>
</svg>
<div id="tweet"></div>
</div>
<div id="mapid"></div>

<script>

// Notes:
// I'm basically trying to create a simple map that will display social media posts when markers are clicked.
// It's surprisingly hard to do though.
// Twitter's API doesn't seem to support CORS. So I had problems trying to embed the HTML snippets from its JSONs into the Leaflet popups. Since I didn't want to manually extract the appropriate HTML snippets for each post, I ended up having to just display the posts in a side pane.
// Instagram's API seems to be getting deprecated in favor of their Graph API which requires authentication. I didn't want to do authentication. So I went with the old API, which I think no longer displays the photos from the posts.
// Facebook's Graph API also requires authentication, which I didn't want to do. So I didn't do Facebook.

// Stamen layers
var s_stamen_copyright = 'Map tiles by <a href="https://stamen.com">Stamen Design</a>, under <a href="https://creativecommons.org/licenses/by/3.0">CC BY 3.0</a>. Data by <a href="https://openstreetmap.org">OpenStreetMap</a>, under <a href="https://www.openstreetmap.org/copyright">ODbL</a>.'; // used for all sets except Watercolor
var s_stamen_urlbase = 'https://stamen-tiles-{s}.a.ssl.fastly.net/';
var l_stamen_watercolor = L.tileLayer(s_stamen_urlbase+'watercolor/{z}/{x}/{y}.jpg',{maxZoom:20, attribution:'Map tiles by <a href="http://stamen.com">Stamen Design</a>, under <a href="https://creativecommons.org/licenses/by/3.0">CC BY 3.0</a>. Data by <a href="https://openstreetmap.org">OpenStreetMap</a>, under <a href="https://creativecommons.org/licenses/by-sa/3.0">CC BY SA</a>.'});
var l_stamen_terrain = L.tileLayer(s_stamen_urlbase+'terrain/{z}/{x}/{y}.jpg',{maxNativeZoom:16, attribution:s_stamen_copyright});
var l_stamen_terrainbg = L.tileLayer(s_stamen_urlbase+'terrain-background/{z}/{x}/{y}.jpg',{maxNativeZoom:16, attribution:s_stamen_copyright});
var l_stamen_terrainlines = L.tileLayer(s_stamen_urlbase+'terrain-lines/{z}/{x}/{y}.jpg',{maxNativeZoom:16, attribution:s_stamen_copyright});
var l_stamen_terrainlabels = L.tileLayer(s_stamen_urlbase+'terrain-labels/{z}/{x}/{y}.jpg',{maxNativeZoom:16, attribution:s_stamen_copyright});
var l_stamen_toner = L.tileLayer(s_stamen_urlbase+'toner/{z}/{x}/{y}.png',{maxZoom:20, attribution:s_stamen_copyright});
var l_stamen_tonerlite = L.tileLayer(s_stamen_urlbase+'toner-lite/{z}/{x}/{y}.png',{maxZoom:20, attribution:s_stamen_copyright});
var l_stamen_tonerbg = L.tileLayer(s_stamen_urlbase+'toner-background/{z}/{x}/{y}.png',{maxZoom:20, attribution:s_stamen_copyright});
var l_stamen_tonerhybrid = L.tileLayer(s_stamen_urlbase+'toner-hybrid/{z}/{x}/{y}.png',{maxZoom:20, attribution:s_stamen_copyright});
var l_stamen_tonerlines = L.tileLayer(s_stamen_urlbase+'toner-lines/{z}/{x}/{y}.png',{maxZoom:20, attribution:s_stamen_copyright});
var l_stamen_tonerlabels = L.tileLayer(s_stamen_urlbase+'toner-labels/{z}/{x}/{y}.png',{maxZoom:20, attribution:s_stamen_copyright});

// OpenStreetMaps & OpenTopoMap
var l_osm_fr = L.tileLayer('https://{s}.tile.openstreetmap.fr/osmfr/{z}/{x}/{y}.png', {maxZoom:20, attribution:'donn&eacute;es &copy; <a href="https://osm.org/copyright">OpenStreetMap</a>/ODbL - rendu <a href="https://openstreetmap.fr">OSM France</a>'});
var l_osm_hot = L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', {maxZoom:19, attribution:'donn&eacute;es &copy; <a href="https://osm.org/copyright">OpenStreetMap</a>/ODbL - Tiles courtesy of <a href="https://hot.openstreetmap.org/">Humanitarian OpenStreetMap Team</a>'});
var l_otm = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png',{maxNativeZoom:17, attribution:'Kartendaten: &copy; <a href="https://openstreetmap.org/copyright">OpenStreetMap</a>-Mitwirkende, SRTM | Kartendarstellung: &copy; <a href="http://opentopomap.org/">OpenTopoMap</a> (<a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-SA</a>)'});

//debug layer
var l_debug = L.gridLayer.debugCoords();

// create map, and set default center coordinates, zoom level, and layers
var mymap = L.map('mapid', {
   center: [29.71475,-95.3888],
   zoom: 15,
   layers: [l_otm],
   doubleClickZoom: false
});

// define available basemaps (can view only one at a time)
var basemaps = {
   "Stamen Watercolor": l_stamen_watercolor,
   "Stamen Terrain Terrain": l_stamen_terrain,
   "Stamen Terrain Background": l_stamen_terrainbg,
   "Stamen Toner": l_stamen_toner,
   "Stamen Toner Background": l_stamen_tonerbg,
   "Stamen Toner Lite": l_stamen_tonerlite,
   "OpenTopoMap": l_otm,
   "OpenStreetMap France": l_osm_fr,
   "OpenStreetMap Humanitarian": l_osm_hot,
};

// define available overlay maps (can view more than one at a time, arranged in order from lowest to highest)
var overlaymaps = {
   "Stamen Terrain Lines": l_stamen_terrainlines,
   "Stamen Toner Lines": l_stamen_tonerlines,
   "Stamen Toner Hybrid": l_stamen_tonerhybrid,
   "Stamen Terrain Labels": l_stamen_terrainlabels,
   "Stamen Toner Labels": l_stamen_tonerlabels,
   "Debug Grid":l_debug,
};

// add a layer selector control and scale bar
L.control.layers(basemaps, overlaymaps).addTo(mymap);
L.control.scale().addTo(mymap);

/*
// this is used only by the mymap.on function below
function fgetScript(source, callback) {
    var script = document.createElement('script');
    var prior = document.getElementsByTagName('script')[0];
    script.async = 1;
    script.onload = script.onreadystatechange = function( _, isAbort ) {
        if(isAbort || !script.readyState || /loaded|complete/.test(script.readyState) ) {
            script.onload = script.onreadystatechange = null;
            script = undefined;
            if(!isAbort) { if(callback) callback(); }
        };
    };
    script.src = source;
    prior.parentNode.insertBefore(script, prior);
};

// this would have been used to put Twitter posts in the Leaflet pop-ups, if Twitter had supported CORS
mymap.on('popupopen', function(e) {
    //fgetScript("https://platform.instagram.com/en_US/embeds.js");
//    fgetScript("https://www.instagram.com/embed.js");
//    var px = mymap.project(e.popup._latlng); // find the pixel location on the map where the popup anchor is
//    px.y -= e.popup._container.clientHeight; // find the height of the popup container, divide by 2, and subtract from the Y axis of marker location
//    mymap.panTo(mymap.unproject(px),{animate: true}); // pan to new center
});
*/

var tweetarray = [
   {iid:'B5i76v8AVYE',tid:'1201233312976642049',lat:29.721452,lng:-95.390876,descr:'Sam Houston'},
   {iid:'B5kwSBZni7G',tid:'1201520255102857217',lat:29.720247,lng:-95.391119,descr:'Reflection Pool'},
   {iid:'B5nfRD9gu-4',tid:'1201901368891584512',lat:29.719219,lng:-95.38491,descr:'Conservancy Office'},
   {iid:'B5qQlJTgH80',tid:'',lat:29.720619,lng:-95.387337,descr:'Rose Garden'},
   {iid:'B5s_wbSpa5C',tid:'',lat:29.719197,lng:-95.392971,descr:'Japanese Garden'},
   {iid:'B5vMB_mAF3Q',tid:'1202984869594312704',lat:29.719782,lng:-95.385979,descr:'Marvin Taylor Trail'},
   {iid:'B5yPuBwBu5C',tid:'1203415161819860992',lat:29.721578,lng:-95.387046,descr:'Family Garden Beehive'},
   {iid:'B50380tJYmr',tid:'',lat:29.716874,lng:-95.389516,descr:'Gift Shop'},
   {iid:'B53BDszj8v6',tid:'',lat:29.721468,lng:-95.38704,descr:'Family Garden'},
   {iid:'B55fDSnJNtO',tid:'',lat:29.716566,lng:-95.388909,descr:'Parking Lot'},
   {iid:'B58Oa8FH3Ez',tid:'1204819670790033408',lat:29.717511,lng:-95.389623,descr:'Kinder Station'},
   {iid:'B5-j8Gnp4n1',tid:'',lat:29.72081,lng:-95.386458,descr:'Cherie Flores Pavilion'},
   {iid:'B6BCt3IDLRy',tid:'',lat:29.721649,lng:-95.387216,descr:'Story Hour at the Family Garden'},
   {iid:'B6Dly7jj3yp',tid:'1205856239604977665',lat:29.715968,lng:-95.394028,descr:'Playground for All'},
   {iid:'B6GX3gipfet',tid:'',lat:29.721577,lng:-95.387946,descr:'the Mount'},
   {iid:'B6I-Iy3JkQ3',tid:'',lat:29.719849,lng:-95.3889,descr:'Miller Theatre'},
   {iid:'B6L6rtEHr3-',tid:'1207027985548791808',lat:29.721271,lng:-95.387174,descr:'Pergola Walk'},
   {iid:'',tid:'1207035234228867072',lat:29.717333,lng:-95.389214,descr:'B-Cycle Station'},
   {iid:'B6OFOHIHUWb',tid:'',lat:29.71723,lng:-95.389857,descr:'Pinewood Cafe'},
];

let igpuburl = 'https://api.instagram.com/oembed/?url=http://instagr.am/p/{id}/';
function fgetightml(id) {
   return fetch(igpuburl.replace('{id}',id))
      .then((response) => {
         if (!response.ok) { throw new Error(response.status+': '+response.statusText); };
         return response.json();
      })
      .then((data) => { return data.html; })
      .catch((err) => { console.error(err); });
};

/*
let twttrpuburl = 'https://publish.twitter.com/oembed?url=https://twitter.com/hermannpark/status/{id}';
async function fgettweethtml(id) {
   await fetch(new Request(twttrpuburl.replace('{id}',id)));
   let oembedTweet = oembedResponse.json();
   return oembedTweet.html;
};
*/

for (i=0;i<tweetarray.length;i++) {
//   var test = fgettweethtml(tweetarray[i].tid);
   var prom0 = Promise.resolve(tweetarray[i]);
   var prom1 = fgetightml(tweetarray[i].iid);
   Promise.all([prom0,prom1]).then(function(values) {
      var lat = values[0].lat;
      var lng = values[0].lng;
      var tid = values[0].tid;
      var iid = values[0].iid;
      var ihtml = values[1];
      var marker = L.marker([lat,lng],{alt:tid})
      .addTo(mymap)
      .bindPopup(ihtml,{maxWidth:325});
      marker.on('click', function(e) {
         var tweet = document.getElementById('tweet');
         tweet.innerHTML = '';
         twttr.widgets.ready;
         twttr.widgets.createTweet(e.sourceTarget.options.alt,tweet);
      });
   });
};

/*
for (j=0;j<tweetarray.length;j++) {
   var marker = L.marker([tweetarray[j].lat,tweetarray[j].lng],{alt:tweetarray[j].id})
   .addTo(mymap);
   .bindPopup(tweethtml,{maxWidth:275})
   marker.on('click', function(e) {
      var tweet = document.getElementById('tweet');
      tweet.innerHTML = '';
      twttr.widgets.ready;
      twttr.widgets.createTweet(e.sourceTarget.options.alt,tweet);     
   });
};
*/

</script>
</body>
</html>